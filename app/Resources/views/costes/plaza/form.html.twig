<script>
    $(document).ready(function () {
        $("#costesbundle_plaza_codigoUf").change(function () {
            let valor, recurso;
            $("#procesando").show();
            valor = $("#costesbundle_plaza_codigoUf").val();
            recurso = Routing.generate("ajaxVerUf", {"codigo": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_descripcionUf").val(data.descripcion);
                    $("#costesbundle_plaza_uf").val(data.id);

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });
        $("#costesbundle_plaza_codigoPa").change(function () {
            let valor, recurso;
            $("#procesando").show();
            valor = $("#costesbundle_plaza_codigoPa").val();
            recurso = Routing.generate("ajaxVerPa", {"codigo": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_descripcionPa").val(data.descripcion);
                    $("#costesbundle_plaza_pa").val(data.id);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });

        $("#costesbundle_plaza_uf").change(function () {
            let valor, recurso;
            $("#procesando").show();
            valor = $("#costesbundle_plaza_uf").val();
            recurso = Routing.generate("ajaxVerUfById", {"id": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_codigoUf").val(data.oficial);
                    $("#costesbundle_plaza_descripcionUf").val(data.descripcion);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });
        $("#costesbundle_plaza_pa").change(function () {
            let valor, recurso;
            //$("#procesando").modal('show');
            $("#procesando").show();
            valor = $("#costesbundle_plaza_pa").val();
            recurso = Routing.generate("ajaxVerPaById", {"id": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_codigoPa").val(data.oficial);
                    $("#costesbundle_plaza_descripcionPa").val(data.descripcion);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });

        $("#costesbundle_plaza_nuevoCeco").change(function () {
            let valor, recurso;
            $("#procesando").show();
            valor = $("#costesbundle_plaza_nuevoCeco").val();
            recurso = Routing.generate("ajaxVerCeco", {"id": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_nuevoCecoCodigo").val(data.codigo);
                    $("#costesbundle_plaza_nuevoCecoDesc").val(data.descripcion);
                    $("#btnAsignacion").show();

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });

        $("#costesbundle_plaza_turnof").change(function () {
            let valor, recurso;
            $("#procesando").show();
            valor = $("#costesbundle_plaza_turnof").val();
            recurso = Routing.generate("ajaxVerTurno", {"id": valor}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_h1ini").val(data.hini);
                    $("#costesbundle_plaza_h2fin").val(data.hfin);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        });


    });

    function cambiarAsignacion() {
        let cias, cecoAnterior, nuevoCeco, fInicio, recurso;
        if ($("#costesbundle_plaza_nuevoCecoInf").val() == '' ||
            $("#costesbundle_plaza_fInicio").val() == '') {
            bootbox.alert("OBLIGATORIO INFORMAR NUEVO CECO  Y FECHA DE INICIO",
                function () {
                });
        } else {
            cias = $("#costesbundle_plaza_cias").val();
            cecoAnterior = $("#costesbundle_plaza_cecoActual").val();
            if (cecoAnterior === '') {
                cecoAnterior = 0;
            }
            nuevoCeco = $("#costesbundle_plaza_nuevoCecoCodigo").val();
            fInicio = $("#costesbundle_plaza_fInicio").val();
            recurso = Routing.generate("cambiarAsignacion", {
                "cias": cias,
                "nuevoCeco": nuevoCeco,
                "fInicio": fInicio,
                "cecoAnterior_id": cecoAnterior
            }, true);
            window.location = recurso;
        }
    }

    function calcularCias() {
        let uf = $("#costesbundle_plaza_uf").val();
        let catgen = $("#costesbundle_plaza_catGen").val();
        let recurso;
        if (uf == '' || catgen == '') {
            bootbox.alert("Unidad Funcional, Punto Asistencia y Categoría Obligatorios");
        } else {
            $("#procesando").show();
            recurso = Routing.generate("calcularCIAS", {"uf_id": uf, "catgen_id": catgen}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_cias").val(data.cias);
                    $("#costesbundle_plaza_orden").val(data.orden);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        }
    }

    function reCalcularCias() {
        let cias = $("#costesbundle_plaza_cias").val();
        let patron = cias.substr(0, 8);
        let orden = $("#costesbundle_plaza_orden").val();
        $("#costesbundle_plaza_cias").val(patron + orden);

    }

    function calcularLetra() {
        let cadena, letra, resto;
        let cias = $("#costesbundle_plaza_cias").val();
        if (cias != '') {
            cadena = 'TRWAGMYFPDXBNJZSQVHLCKE';
            resto = cias % 23;
            letra = cadena.substr(resto, 1);
            $("#costesbundle_plaza_cias").val(cias + letra);
        } else {
            bootbox.alert(' ERROR NO EXISTE CIAS');
        }
    }

    /**
     *
     */
    function desAmortizar() {
        let recurso;
        let cias = $("#costesbundle_plaza_cias").val();
        recurso = Routing.generate("desAmortizacion", {
            "cias": cias
        }, true);
        window.location = recurso;

    }

    function calcularCeco() {
        let recurso;
        let uf = $("#costesbundle_plaza_uf").val();
        let pa = $("#costesbundle_plaza_pa").val();
        let cias = $("#costesbundle_plaza_cias").val();
        if (uf == '' || pa == '' || cias == '') {
            bootbox.alert("Unidad Funcional, Punto Asistencial y Cias Obligatorios");
        } else {
            $("#procesando").show();
            recurso = Routing.generate("ajaxCalcularCeco", {"cias": cias, "uf_id": uf, "pa_id": pa}, true);
            $.ajax({
                type: "POST",
                url: recurso,
                dataType: 'json',
                success: function (data, status, xhr) {
                    $('.modal-backdrop').remove();
                    $("#procesando").hide();
                    $("#costesbundle_plaza_nuevoCecoCodigo").val(data.codigo);
                    $("#costesbundle_plaza_nuevoCecoDesc").val(data.descripcion);
                    if ($("#costesbundle_plaza_nuevoCecoDesc").val() === 'ERROR NO EXISTE CECO') {
                        $("#btnAsignacion").hide();
                    } else {
                        $("#btnAsignacion").show();
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    return null;
                }
            });
        }
    }

    function deletePlaza() {
        let cias, recurso;
        cias = $("#costesbundle_plaza_cias").val();
        recurso = Routing.generate("deletePlaza", {
            "cias": cias,
        }, true);
        alert(recurso);
        window.location = recurso;
    }


</script>


<div class="container-fluid">
    {{ form_start(form) }}
    {{ form_errors(form) }}
    <div class="panel panel-default">
        <div class="panel-heading">Identificación</div>
        <div class="panel-body">
            <div class="form_row mismalinea">{{ form_row(form.codigoUf) }}</div>
            <div class="form_row mismalinea">{{ form_row(form.descripcionUf) }}</div>
            <div class="form_row mismalinea">{{ form_row(form.uf) }}</div>
            <div class="clearfix"></div>
            <div class="form_row mismalinea">{{ form_row(form.codigoPa) }}</div>
            <div class="form_row mismalinea">{{ form_row(form.descripcionPa) }}</div>
            <div class="form-row  mismalinea">{{ form_row(form.pa) }}</div>
            <div class="clearfix"></div>
            <div class="form-row mismalinea">{{ form_row(form.catGen) }}</div>
            <div class="form-row  mismalinea">{{ form_row(form.cias) }}</div>
            <div class="form-row  mismalinea">{{ form_row(form.orden) }}</div>
            {% if accion == 'NUEVA' %}
                <div class="form-row  mismalinea">
                    <button type="button"
                            class="btn btn-default btn-info"
                            onclick="calcularCias()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Calcular Identificación de Plaza">Calcular CIAS
                    </button>
                </div>
                <div class="form-row  mismalinea">
                    <button type="button"
                            class="btn btn-default btn-info"
                            onclick="reCalcularCias()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Recalcular CIAS según nuevo orden">Recalcular CIAS
                    </button>
                </div>
                <div class="form-row  mismalinea">
                    <button type="button"
                            class="btn btn-default btn-info"
                            onclick="calcularLetra()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Calcular letra de Control de Plaza">Calcular Letra
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
    <div id="tabs" class="pestana container">
        <ul class="nav nav-tabs">
            <li><a id="tdatosGen" href="#datosGen">Datos Generales</a></li>
            {% if accion == 'MODIFICACIÓN' %}
                <li><a id="tdatosGen" href="#consulta">Histórico Centros de Coste</a></li>
                <li><a id="tcostes" href="#costes">Cambio de Asignación</a></li>
            {% endif %}
        </ul>
        <div id="datosGen">
            <div class="form-row mismalinea">{{ form_row(form.modalidad) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.catFp) }}</div>
            <div class="clearfix"></div>
            <div class="form-row mismalinea">{{ form_row(form.turnof) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.h1ini) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.h1fin) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.h2ini) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.h2fin) }}</div>
            <div class="clearfix"></div>

            <div class="form-row ">{{ form_row(form.observaciones) }}</div>
            <div class="clearfix"></div>
            <div class="form-row mismalinea">{{ form_row(form.fCreacion) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.fAmortiza) }}</div>
            {% if (plaza.fAmortiza != '' ) %}
                <div class="form-row  mismalinea">
                    <button type="button"
                            class="btn btn-default btn-warning"
                            onclick="desAmortizar()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Desamortizar la Plaza"> Quitar Amortización
                    </button>
                </div>
            {% endif %}
            <div class="clearfix"></div>
            <div class="form-row mismalinea" style="display: none">{{ form_row(form.refuerzo) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.plantilla) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.ficticia) }}</div>
            <div class="form-row mismalinea" style="display: none">>{{ form_row(form.colaboradora) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.horNormal) }}</div>
            <div class="form-row mismalinea">{{ form_row(form.cupequi) }}</div>
            <div class="clearfix"></div>
        </div>
        {% if accion == 'MODIFICACIÓN' %}
            <div id="consulta">
                {% if (datatable != '' ) %}
                    {{ sg_datatables_render(datatable) }}
                {% endif %}
            </div>
            <div id="costes">
                <div class="form-row mismalinea">{{ form_row(form.cecoActual) }}</div>
                <div class="clearfix"></div>
                <div class="form-row mismalinea">{{ form_row(form.nuevoCecoCodigo) }}</div>
                <div class="form-row mismalinea">{{ form_row(form.nuevoCecoDesc) }}</div>
                <div class="form-row mismalinea">{{ form_row(form.nuevoCeco) }}</div>
                <div class="form-row mismalinea">{{ form_row(form.fInicio) }}</div>
                <div class="form-row mismalinea">
                    <button type="button"
                            class="btn btn-default btn-warning btn-t"
                            onclick="calcularCeco()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Calculo Automático de Centro de Coste"> Calcular Centro de Coste
                    </button>
                </div>
                <div class="form-row mismalinea">
                    <button type="button"
                            id="btnAsignacion"
                            class="btn btn-default btn-info btn-t"
                            onclick="cambiarAsignacion()"
                            data-toggle="tooltip"
                            data-placement="bottom"
                            title="Cambiar Asginación de Centro de Coste"> Cambiar Asignación
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
    <div class="form_row mismalinea">
        {{ form_row(form.Guardar) }}
    </div>
    <div class="form-row mismalinea">
        <button type="button"
                id="btnAsignacion"
                class="btn btn-default btn-danger btn-t"
                onclick="deletePlaza()"
                data-toggle="tooltip"
                data-placement="bottom"
                title="Eliminar Plaza"> Eliminar Plaza
        </button>
    </div>

</div>
